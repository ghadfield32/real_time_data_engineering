# =============================================================================
# Template Pipeline: Flink 2.0.x Configuration
# =============================================================================
# Production-ready configuration for Flink 2.0.x with Iceberg + Redpanda.
# This file is mounted into the JobManager container at /opt/flink/conf/config.yaml.
#
# Flink 2.0 note: The config file is now standard YAML 1.2 (config.yaml),
# NOT the legacy key=value flink-conf.yaml format from Flink 1.x.
# =============================================================================

# Cluster coordination
jobmanager.rpc.address: flink-jobmanager
jobmanager.rpc.port: 6123
jobmanager.bind-host: 0.0.0.0
jobmanager.memory.process.size: 1600m

taskmanager.bind-host: 0.0.0.0
taskmanager.host: flink-taskmanager
taskmanager.memory.process.size: 2048m
taskmanager.numberOfTaskSlots: 4

parallelism.default: 2

# REST API (Flink Dashboard)
rest.address: 0.0.0.0
rest.bind-address: 0.0.0.0
rest.port: 8081
rest.flamegraph.enabled: true

# =============================================================================
# State Backend (CRITICAL for production streaming)
# =============================================================================
# RocksDB = disk-spilling, incremental checkpoints. Required for:
#   - Large state (window aggregations, deduplication state)
#   - Fault tolerance (state survives TaskManager restart)
# DO NOT use 'hashmap' in production — it's heap-only, lost on crash.
state.backend: rocksdb
state.backend.incremental: true

# Durable checkpoint storage on MinIO (s3a://warehouse/checkpoints)
# CRITICAL: NOT /tmp/ — ephemeral container storage loses state on restart.
# Checkpoints enable exactly-once recovery from broker/task failures.
state.checkpoints.dir: s3a://warehouse/checkpoints
state.savepoints.dir: s3a://warehouse/savepoints

# =============================================================================
# Checkpointing
# =============================================================================
execution.checkpointing.interval: 30s
execution.checkpointing.mode: EXACTLY_ONCE
execution.checkpointing.min-pause: 10s
execution.checkpointing.timeout: 5min

# =============================================================================
# Table / SQL Configuration
# =============================================================================
# TTL=0: retain deduplication state forever (important for exactly-once Bronze writes)
table.exec.state.ttl: 0
# DROP: silently discard rows that violate NOT NULL constraints (instead of failing)
table.exec.sink.not-null-enforcer: DROP

# =============================================================================
# Classloader (Required for Iceberg)
# =============================================================================
# Iceberg uses dynamic class loading for its Avro/Parquet readers. Without this,
# Flink incorrectly reports a "classloader leak" after batch DML sync jobs.
classloader.check-leaked-classloader: false

# =============================================================================
# S3 / MinIO Filesystem Configuration
# =============================================================================
# Used by Flink's native S3A filesystem (for checkpoint storage).
# The Iceberg catalog separately uses these credentials via the Hadoop core-site.xml.
s3.endpoint: http://minio:9000
s3.access-key: minioadmin
s3.secret-key: minioadmin
s3.path.style.access: true

# =============================================================================
# Metrics: Prometheus reporter
# =============================================================================
# Exposed on :9249 — add this port to docker-compose.yml flink-jobmanager ports.
# Scrape with Prometheus + visualize in Grafana for production observability.
metrics.reporter.prom.factory.class: org.apache.flink.metrics.prometheus.PrometheusReporterFactory
metrics.reporter.prom.port: 9249

# =============================================================================
# Logging
# =============================================================================
env.log.max: 5
env.log.dir: /opt/flink/log
